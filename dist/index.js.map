{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["/**\r\n * 已知的图片魔数\r\n * @type {Uint8Array[]}\r\n */\r\nconst KNOWN_IMAGE_MAGIC_NUMBER = [\r\n    new Uint8Array([0xff, 0xd8, 0xff]), // JPEG\r\n\r\n    new Uint8Array([0x89, 0x50, 0x4e, 0x47]), // PNG\r\n    new Uint8Array([0x47, 0x49, 0x46, 0x38]), // GIF\r\n    new Uint8Array([0x49, 0x49, 0x2a, 0x00]), // TIFF\r\n    new Uint8Array([0x4d, 0x4d, 0x00, 0x2a]), // TIFF\r\n\r\n    new Uint8Array([0x00, 0x00, 0x01, 0x00]), // ICO\r\n    new Uint8Array([0x00, 0x00, 0x02, 0x00]), // ICO\r\n    new Uint8Array([0x42, 0x50, 0x47, 0xfb]), // BPG\r\n    new Uint8Array([0x46, 0x4f, 0x52, 0x4d]), // HEIF\r\n\r\n    new Uint8Array([0x52, 0x49, 0x46, 0x46]), // WEBP\r\n\r\n]\r\nconst MAX_MAGIC_NUMBER_LENGTH = Math.max(...KNOWN_IMAGE_MAGIC_NUMBER.map(v => v.length))\r\n/**\r\n * 尝试得到异或加密使用的key\r\n * @param {ArrayBuffer} buf \r\n * @returns {number | undefined} key\r\n */\r\n\r\nexport function tryGetKey(buf) {\r\n    const header = new Uint8Array(buf.slice(0, MAX_MAGIC_NUMBER_LENGTH))\r\n    // key长度一般为1个字节\r\n    // 查找异或后重复超过2次的字节\r\n    const xorResult = new Uint8Array(MAX_MAGIC_NUMBER_LENGTH)\r\n    /**\r\n     * @type {number | undefined}\r\n     */\r\n    let lastMagicNumberLength\r\n    magicNumberIterate: for (const magicNumber of KNOWN_IMAGE_MAGIC_NUMBER) {\r\n        if (typeof lastMagicNumberLength === 'number' && lastMagicNumberLength !== magicNumber.length) {\r\n            // 清空xorResult\r\n            for (let i = 0; i < magicNumber.length; i++) {\r\n                xorResult[i] = 0\r\n            }\r\n        }\r\n        lastMagicNumberLength = magicNumber.length\r\n        for (let i = 0; i < magicNumber.length; i++) {\r\n            xorResult[i] = header[i] ^ magicNumber[i]\r\n        }\r\n        const keyPossible = xorResult[0]\r\n        console.log(xorResult)\r\n\r\n        for (let i = 1; i < magicNumber.length; i++) {\r\n            if (xorResult[i] !== keyPossible) {\r\n                continue magicNumberIterate\r\n            }\r\n        }\r\n        return keyPossible\r\n\r\n    }\r\n}\r\n/**\r\n * 根据key对buf逐字节进行异或处理\r\n * \r\n * @param {ArrayBuffer} buf \r\n * @param {number} key \r\n * @returns {ArrayBufferLike}\r\n */\r\nexport function xor(buf, key) {\r\n    const result = new Uint8Array(buf.byteLength)\r\n    const data = new Uint8Array(buf)\r\n    for (let i = 0; i < data.length; i++) {\r\n        result[i] = data[i] ^ key\r\n    }\r\n    return result.buffer\r\n}\r\n\r\n"],"names":["KNOWN_IMAGE_MAGIC_NUMBER","Uint8Array","MAX_MAGIC_NUMBER_LENGTH","Math","max","map","v","length","tryGetKey","buf","header","slice","xorResult","lastMagicNumberLength","magicNumberIterate","magicNumber","i","keyPossible","console","log","xor","key","result","byteLength","data","buffer"],"mappings":"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"}