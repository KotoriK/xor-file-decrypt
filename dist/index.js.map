{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["/**\n * 已知的图片魔数\n * @type {Uint8Array[]}\n */\nconst KNOWN_IMAGE_MAGIC_NUMBER = [\n    new Uint8Array([0xff, 0xd8, 0xff]), // JPEG\n\n    new Uint8Array([0x89, 0x50, 0x4e, 0x47]), // PNG\n    new Uint8Array([0x47, 0x49, 0x46, 0x38]), // GIF\n    new Uint8Array([0x49, 0x49, 0x2a, 0x00]), // TIFF\n    new Uint8Array([0x4d, 0x4d, 0x00, 0x2a]), // TIFF\n\n    new Uint8Array([0x00, 0x00, 0x01, 0x00]), // ICO\n    new Uint8Array([0x00, 0x00, 0x02, 0x00]), // ICO\n    new Uint8Array([0x42, 0x50, 0x47, 0xfb]), // BPG\n    new Uint8Array([0x46, 0x4f, 0x52, 0x4d]), // HEIF\n\n    new Uint8Array([0x52, 0x49, 0x46, 0x46]), // WEBP\n\n]\nconst MAX_MAGIC_NUMBER_LENGTH = Math.max(...KNOWN_IMAGE_MAGIC_NUMBER.map(v => v.length))\n/**\n * 尝试得到异或加密使用的key\n * @param {ArrayBuffer} buf \n * @returns {number | undefined} key\n */\n\nexport function tryGetKey(buf) {\n    const header = new Uint8Array(buf.slice(0, MAX_MAGIC_NUMBER_LENGTH))\n    // key长度一般为1个字节\n    // 查找异或后重复超过2次的字节\n    const xorResult = new Uint8Array(MAX_MAGIC_NUMBER_LENGTH)\n    let lastMagicNumberLength = 0\n    magicNumberIterate: for (const magicNumber of KNOWN_IMAGE_MAGIC_NUMBER) {\n        if (lastMagicNumberLength && lastMagicNumberLength !== magicNumber.length) {\n            // 清空xorResult\n            for (let i = 0; i < magicNumber.length; i++) {\n                xorResult[i] = 0\n            }\n        }\n        lastMagicNumberLength = magicNumber.length\n        for (let i = 0; i < magicNumber.length; i++) {\n            xorResult[i] = header[i] ^ magicNumber[i]\n        }\n        const keyPossible = xorResult[0]\n\n        for (let i = 1; i < magicNumber.length; i++) {\n            if (xorResult[i] !== keyPossible) {\n                continue magicNumberIterate\n            }\n        }\n        return keyPossible\n    }\n\n}\n/**\n * 根据key对buf逐字节进行异或处理\n * \n * @param {ArrayBuffer} buf \n * @param {number} key \n * @returns {ArrayBuffer}\n */\nexport function xor(buf, key) {\n    const result = new Uint8Array(buf.byteLength)\n    const data = new Uint8Array(buf)\n    for (let i = 0; i < data.length; i++) {\n        result[i] = data[i] ^ key\n    }\n    return result.buffer\n}\n\n"],"names":["KNOWN_IMAGE_MAGIC_NUMBER","Uint8Array","MAX_MAGIC_NUMBER_LENGTH","Math","max","map","v","length","tryGetKey","buf","header","slice","xorResult","lastMagicNumberLength","magicNumberIterate","magicNumber","i","keyPossible","xor","key","result","byteLength","data","buffer"],"mappings":"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"}